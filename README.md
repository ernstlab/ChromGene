# ChromGene: Gene-Based Modelling of Epigenomic Data

## Design
ChromGene is a method for annotating genomic intervals by modeling them as arising from a mixture of Hidden Markov Models (HMMs). As with a Gaussian Mixture Model, where each point is assumed to have been generated by exactly one Gaussian distribution, each gene is assumed to be generated by exactly one HMM. Each HMM is fully-connected, and is defined by emission parameters of each of S states, the transition parameters between them, and the prior probabilities of each state.

## Usage
ChromGene can be applied to any genomic intervals where histone marks and DNA accessibility tracks are expected to vary across the genome by modifying the provided code.

We applied ChromGene to a set of 19,919 protein-coding genes across 127 imputed epigenomes (Frankish et al. 2018, Roadmap Epigenomics Consortium et al. 2015). The full set of annotations is reported in this repository, and their descriptions and various metrics are reported in Supp. Table 1. Along with the annotations, we have included code to generate input files to use on top of ChromHMM (Ernst and Kellis, 2012), and to generate a ChromGene assignment matrix.

Usage requires only basic Python packages, which can be easily installed with Anaconda or pip.

First, create the input binary files to use on top of ChromHMM. This will require either a GTF or BED file to demarcate the positions of genes:
```
python generate_chromgene_input_files.py \
annotation [path to bed or gtf file] \
mark_files [ChromHMM chromatin mark binary call file paths] \
--num_states [number of states per mixture; default: 3] \
--num_mixtures [number of mixtures; default: 12] \
--binary [whether to output binary files, can be set to False for testing; default: True] \
--model_param [whether to output model param files, can be set to False for testing; default: True] \
--resolution [resolution of data to output; default: 200] \
--subsample [fraction to subsample positions to initialize ChromGene emission parameters; default: 1] \
--window [bases to go up/downstream of TSS/TES for flanking regions; default: 2000] \
--output_tss [only output TSS binary; default: False] \
--out_dir [output directory; default="."] \
--verbose [verbose; default: False]
```

Second, run ChromHMM on the binary files, passing the model file and binaries deposited into `out_dir`. The argument `total_num_states` should be (num_mixtures * num_states) + 1. The latest version of ChromHMM can be downloaded at https://ernstlab.biolchem.ucla.edu/ChromHMM/. 
`java -jar -mx24000M  path/to/ChromHMM.jar LearnModel -b 200 -d -1 -gzip -holdcolumnorder -holdroworder -init load -m path_to_model_file/model_n.txt -n 100 -lowmem -printstatebyline ./binaries/chromgene_binaries ./out_dir total_num_states hg19`

Finally, create the ChromGene mixture assignments. This will create .npy files and .txt files
```
python chromgene_posteriors_to_mixtures.py
--segmentation_dir [directory with segmentation files; default: '.']
--states_per_mixture [number of states per mixture; default: 4]
--out_dir [directory in which to save data; default: '.']
```

## Annotations
We have generated ChromGene annotations for 127 cell types across 19,919 protein-coding genes using a single, unified model trained on 11 imputed histone marks and DNase. We have included these files in the main repository in the files `chromgene_assignments_eids.tsv.gz` for columns corresponding to EIDs, and the longer cell type name in `chromgene_assignments_cell_type_names.tsv.gz`. The correspondence between these two is available through Roadmap at https://docs.google.com/spreadsheets/d/1yikGx4MsO9Ei36b64yOy9Vb6oPC5IBGlFbYEt-N6gOM/edit#gid=15.


# Legends for additional supplementary files
Supplementary Table 1:
Mixture enrichments tab – The columns on this tab after the mixture colors are as follows:
Mnemonic: short identifying name of ChromGene annotation
Description: short description of ChromGene annotation
Overall percentage: percentage of gene-cell type combinations assigned to annotation
Median expression: median expression (RPKM) of genes assigned to annotation across 56 cell types with expression [1]
Median length (kb): median length (kb) of genes assigned to annotation across all cell types, not including flanking regions
Percentage of high-pLI genes (pLI > 0.9): percentage of genes across cell types that have a pLI score > 0.9
Contingency table diagonal / confusion matrix diagonal: percentage consistency of annotations across non-replicate cell types divided by percentage consistency of annotations across replicate cell types
Cell type specificity: 1 - (contingency table diagonal / confusion matrix diagonal), a metric of cell type specificity

### Housekeeping gene: gene annotated as housekeeping [35]
Housekeeping gene percentage: percentage of gene-cell type combinations annotated as a housekeeping gene
Housekeeping gene enrichment: fold enrichment of housekeeping genes compared to overall percentage
Housekeeping gene log2 enrichment: log2 fold enrichment of housekeeping genes
Housekeeping gene enrichment median enrichment p-value: median p-value of housekeeping gene enrichment across cell types

### Constitutively unexpressed gene: gene that has RPKM < 1 across 56 cell types with expression [1]
Constitutively unexpressed gene percentage: percentage of gene-cell type combinations annotated as constitutively unexpressed 
Constitutively unexpressed gene enrichment: fold enrichment of constitutively unexpressed genes compared to overall percentage
Constitutively unexpressed gene log2 enrichment: log2 fold enrichment of constitutively unexpressed genes
Constitutively unexpressed gene median enrichment p-value: median p-value of constitutively unexpressed gene enrichment across cell types

### Constitutively expressed gene: gene that has RPKM > 1 across 56 cell types with expression [1]
Constitutively expressed gene percentage: percentage of gene-cell type combinations annotated as constitutively expressed 
Constitutively expressed gene enrichment: fold enrichment of constitutively expressed genes compared to overall percentage
Constitutively expressed gene log2 enrichment: log2 fold enrichment of constitutively expressed genes
Constitutively expressed gene median enrichment p-value: median p-value of constitutively expressed gene enrichment across cell types

### Olfactory gene: gene annotated as olfactory [30]
Olfactory gene percentage: percentage of gene / cell type combinations annotated as olfactory 
Olfactory gene enrichment: fold enrichment of olfactory genes compared to overall percentage
Olfactory gene log2 enrichment: log2 fold enrichment of olfactory genes
Olfactory gene median enrichment p-value: median p-value of olfactory gene enrichment across cell types

### ZNF gene: gene starts with "ZNF"
ZNF gene percentage: percentage of gene / cell type combinations annotated as ZNF 
ZNF gene enrichment: fold enrichment of ZNF genes compared to overall percentage
ZNF gene log2 enrichment: log2 fold enrichment of ZNF genes
ZNF gene median enrichment p-value: median p-value of ZNF gene enrichment across cell types

### Cancer and BP GO terms
Cancer gene sets enriched (adj p < 0.01): the number of cancer gene sets enriched across all cell types for given annotation
Cancer gene sets enriched percentage: the percentage of cancer gene sets enriched across all cell types for given annotation
BP GO terms enriched (adj p < 0.01): the number of 'Biological Process' GO term gene sets enriched across all cell types for given annotation
BP GO terms enriched percentage: the percentage of 'Biological Process' GO term gene sets enriched across all cell types for given annotation

Color (hex): hex color for ChromGene annotation
Matplotlib color name: color used in matplotlib for ChromGene annotation [https://xkcd.com/color/rgb/]

State emissions and enrichments tab – The first column gives a color and number for each mixture. The second column gives the mixture mnemonic. The third column gives a number to each individual state of the mixture. The next 12 columns give the emission probabilities for each chromatin mark as indicated. The next two columns gives the maximum and minimum emission probabilities represented as percentages. The next column gives the enrichment of the individual states for annotated TSS. Individual states within each mixture are ordered in decreasing value of this enrichment. The next column gives the initial probability of starting in the state overall. The last column gives the initial probability of the state given the mixture.

Transition Probabilities tab – This tab shows the transition probability indicating the probability when in the state of the row of transitioning to the state of the column. Probabilities are shown for individual states of the model which are ordered and colored based on the mixture to which they belong as indicated.

Supplementary Data: ChromGene annotations
This is a gzip of a tab delimited file containing the ChromGene annotations for the 127 cell types. Each row after the header row corresponds to one gene. The first five columns from left to right are the chromosome of the gene, the left-most coordinate of the gene, the right-most coordinate of the gene, the gene symbol, and strand of the gene. This is based on hg19 and ENSEMBL v65/GENCODE v10. The remaining columns correspond to different cell types for which ChromGene annotations are reported as indicated by the names in the header.
